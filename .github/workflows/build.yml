name: Build R33 for OnePlus Pad Pro

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'Kernel Version'
        required: true
        default: '6.1.75'
        type: choice
        options:
          - '6.1.75'
          - '6.1.118'

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout R33
      uses: actions/checkout@v3
      with:
        repository: abcz316/rwProcMem33
        
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget xz-utils make git bc bison flex libssl-dev
        
    - name: Download Android GCC 4.9 Toolchain (Google Official)
      run: |
        echo "Downloading Android GCC 4.9 from Google..."
        # 使用 Google 官方源
        wget -q "https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/+archive/refs/tags/android-12.1.0_r27.tar.gz" -O gcc-4.9.tar.gz
        mkdir -p android-toolchain
        tar -xf gcc-4.9.tar.gz -C android-toolchain
        ls -la android-toolchain/bin/ || ls -la android-toolchain/
        
    - name: Clone OnePlus Kernel Source
      run: |
        echo "Cloning OnePlus SM8650 kernel..."
        git clone --depth 1 https://github.com/OnePlusOSS/android_kernel_oneplus_sm8650.git oneplus-kernel
        
    - name: Configure Kernel
      run: |
        cd oneplus-kernel
        make ARCH=arm64 O=out oneplus_defconfig 2>/dev/null || \
        make ARCH=arm64 O=out defconfig 2>/dev/null || \
        make ARCH=arm64 defconfig
        make ARCH=arm64 O=out modules_prepare 2>/dev/null || \
        make ARCH=arm64 modules_prepare
        
    - name: Build R33 Modules
      run: |
        export PATH=$(pwd)/android-toolchain/bin:$PATH
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-android-
        export KDIR=$(pwd)/oneplus-kernel
        
        echo "Building with:"
        which aarch64-linux-android-gcc || echo "GCC not found, trying alternative..."
        
        # 如果找不到，直接使用完整路径
        if [ ! -f "$(pwd)/android-toolchain/bin/aarch64-linux-android-gcc" ]; then
          export CC=$(find $(pwd)/android-toolchain -name "aarch64-linux-android-gcc" | head -1)
          export PATH=$(dirname $CC):$PATH
        fi
        
        echo "Building rwProcMem33..."
        cd rwProcMem33Module/rwProcMem_module
        sed -i "s|KDIR.*|KDIR?=$KDIR|" Makefile
        make clean 2>/dev/null || true
        make -j$(nproc) 2>&1 | tee build.log || echo "Build attempted"
        cd ../..
        
        echo "Building hwBreakpointProc33..."
        cd hwBreakpointProcModule/hwBreakpointProc_module
        sed -i "s|KDIR.*|KDIR?=$KDIR|" Makefile
        make clean 2>/dev/null || true
        make -j$(nproc) 2>&1 | tee build.log || echo "Build attempted"
        cd ../..
        
    - name: Collect Output
      run: |
        mkdir -p output
        find . -name "*.ko" -type f -exec cp {} output/ \;
        ls -lh output/ || echo "No .ko files found"
        
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: r33-oneplus-pad-pro-${{ github.event.inputs.kernel_version }}
        path: output/*.ko
