name: Build R33 for OnePlus Pad Pro

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'Kernel Version'
        required: true
        default: '6.1.75'

jobs:
  build:
    runs-on: ubuntu-18.04  # 关键：使用旧版 Ubuntu
    
    steps:
    - name: Checkout R33
      uses: actions/checkout@v3
      with:
        repository: abcz316/rwProcMem33
        
    - name: Install Old GCC
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-4.9-aarch64-linux-gnu wget xz-utils make
        sudo update-alternatives --install /usr/bin/aarch64-linux-gnu-gcc aarch64-linux-gnu-gcc /usr/bin/aarch64-linux-gnu-gcc-4.9 100
        
    - name: Download Kernel
      run: |
        wget -q https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.1.75.tar.xz
        tar -xf linux-6.1.75.tar.xz
        
    - name: Configure Kernel
      run: |
        cd linux-6.1.75
        make ARCH=arm64 defconfig
        make ARCH=arm64 modules_prepare
        
    - name: Build R33
      run: |
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export KDIR=$(pwd)/linux-6.1.75
        
        cd rwProcMem33Module/rwProcMem_module
        sed -i "s|KDIR.*|KDIR?=$KDIR|" Makefile
        make
        
        cd ../..
        cd hwBreakpointProcModule/hwBreakpointProc_module
        sed -i "s|KDIR.*|KDIR?=$KDIR|" Makefile
        make
        
    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: r33-ko
        path: "**/*.ko"
